import{r as X,l as Gt,R as jt,j as rt}from"./index-Cf2K4EOO.js";import"./react-OvXVS5lI.js";class _t{constructor(e,r=.4,i=100){this.lr=r,this.epochs=i,this.weights=Array.from({length:e},()=>(Math.random()-.5)*.02),this.bias=(Math.random()-.5)*.02}activation(e){return e>=0?1:0}predict(e){let r=this.bias;for(let i=0;i<this.weights.length;i++)r+=this.weights[i]*e[i];return this.activation(r)}predictRaw(e){let r=this.bias;for(let i=0;i<this.weights.length;i++)r+=this.weights[i]*e[i];return r}fit(e,r){for(let i=0;i<this.epochs;i++)for(let a=0;a<e.length;a++)this.trainSample(e[a],Number(r[a]))}trainSample(e,r){if(!Array.isArray(e)||e.length!==this.weights.length)throw new Error(`Input vector length (${e&&e.length}) does not match weights length (${this.weights.length}).`);let i=this.bias;for(let s=0;s<this.weights.length;s++)i+=this.weights[s]*e[s];const a=i>=0?1:0,R=r-a;for(let s=0;s<this.weights.length;s++)this.weights[s]+=this.lr*R*e[s];this.bias+=this.lr*R}trainSampleScore01(e,r,i){const a=i>=0?1:0,R=r-a;if(R===0)return;const s=this.lr,w=this.weights;for(let h=0;h<w.length;h++)w[h]+=s*R*e[h];this.bias+=s*R}trainSampleRaw01(e,r){let i=this.bias;const a=this.weights;for(let h=0;h<a.length;h++)i+=a[h]*e[h];const R=i>=0?1:0,s=r-R;if(s===0)return;const w=this.lr;for(let h=0;h<a.length;h++)a[h]+=w*s*e[h];this.bias+=w*s}misclassificationRate(e,r){if(!Array.isArray(e)||!Array.isArray(r)||e.length!==r.length)return NaN;let i=0;for(let a=0;a<e.length;a++){const R=this.predict(e[a]),s=r[a]===1||r[a]==="1"?1:0;R!==s&&i++}return i/e.length}hingeLoss(e,r){if(!Array.isArray(e)||!Array.isArray(r)||e.length!==r.length)return NaN;let i=0;for(let a=0;a<e.length;a++){const R=r[a]===1||r[a]==="1"?1:-1,s=this.predictRaw(e[a]);i+=Math.max(0,1-R*s)}return i/e.length}mseRaw(e,r){if(!Array.isArray(e)||!Array.isArray(r)||e.length!==r.length)return NaN;let i=0;for(let a=0;a<e.length;a++){const R=r[a]===1||r[a]==="1"?1:0,w=this.predictRaw(e[a])-R;i+=w*w}return i/e.length}fitHingeSGD(e,r,i={}){const{epochs:a=10,lr:R=.01,lambda:s=.01,shuffle:w=!0}=i;if(!Array.isArray(e)||!Array.isArray(r)||e.length!==r.length)return;const h=r.map(c=>c===1||c==="1"?1:-1),z=e.length;(!this.weights||this.weights.length===0)&&(this.weights=Array.from({length:e[0].length},()=>Math.random()-.5));const D=Array.from({length:z},(c,j)=>j);for(let c=0;c<a;c++){if(w)for(let j=z-1;j>0;j--){const m=Math.floor(Math.random()*(j+1)),_=D[j];D[j]=D[m],D[m]=_}for(let j=0;j<z;j++){const m=D[j],_=e[m],y=h[m],G=this.predictRaw(_);if(y*G<1){for(let b=0;b<this.weights.length;b++)this.weights[b]=this.weights[b]*(1-R*s)+R*y*_[b];this.bias=this.bias+R*y}else for(let b=0;b<this.weights.length;b++)this.weights[b]=this.weights[b]*(1-R*s)}}}mapLabel(e,r="01"){return r==="01"?e===1||e==="1"||e==="A"?1:0:e===1||e==="1"||e==="A"?1:-1}fitOnline(e,r,i={}){const a=i.epochs??this.epochs,R=i.shuffle??!0,s=i.earlyStop?.patience??0,w=i.earlyStop?.metric??"errors",h=i.lrSchedule;if(!Array.isArray(e)||!Array.isArray(r)||e.length!==r.length||e.length===0)return;let z=1/0,D=this.weights.slice(),c=this.bias,j=0;const m=Array.from({length:e.length},(y,G)=>G);for(let y=0;y<a;y++){const G=Math.max(1e-5,h?h(y,this.lr):this.lr);if(R)for(let t=m.length-1;t>0;t--){const P=Math.floor(Math.random()*(t+1)),$=m[t];m[t]=m[P],m[P]=$}let b=0;for(let t=0;t<m.length;t++){const P=m[t],$=e[P],x=this.mapLabel(r[P],"+-"),S=this.predictRaw($);if(x*S<=0){b++;for(let d=0;d<this.weights.length;d++)this.weights[d]+=G*x*$[d];this.bias+=G*x}}const N=w==="hinge"?this.hingeLoss(e,r):b;if(N<z-1e-12)z=N,D=this.weights.slice(),c=this.bias,j=0;else if(j++,s>0&&j>=s)break;if(b===0)break}this.weights=D,this.bias=c;const _=10;for(let y=0;y<_;y++){let G=0;for(let b=0;b<e.length;b++){const N=e[b],t=this.mapLabel(r[b],"+-"),P=this.predictRaw(N);if(t*P<=0){G++;for(let $=0;$<this.weights.length;$++)this.weights[$]+=this.lr*t*N[$];this.bias+=this.lr*t}}if(G===0)break}}fitAveraged(e,r,i={}){const a=i.epochs??this.epochs,R=i.shuffle??!0;if(!Array.isArray(e)||!Array.isArray(r)||e.length!==r.length||e.length===0)return;const s=Array.from({length:e.length},(j,m)=>m),w=this.weights.slice();let h=this.bias;const z=new Array(w.length).fill(0);let D=0,c=0;for(let j=0;j<a;j++){if(R)for(let m=s.length-1;m>0;m--){const _=Math.floor(Math.random()*(m+1)),y=s[m];s[m]=s[_],s[_]=y}for(let m=0;m<s.length;m++){const _=s[m],y=e[_],G=this.mapLabel(r[_],"+-"),b=h+w.reduce((N,t,P)=>N+t*y[P],0);if(G*b<=0){for(let N=0;N<w.length;N++)w[N]+=this.lr*G*y[N];h+=this.lr*G}for(let N=0;N<w.length;N++)z[N]+=w[N];D+=h,c++}}this.weights=z.map(j=>j/Math.max(1,c)),this.bias=D/Math.max(1,c)}fitPocket(e,r,i={}){const a=i.epochs??this.epochs,R=i.shuffle??!0,s=i.maxUpdates??a*e.length;if(!Array.isArray(e)||!Array.isArray(r)||e.length!==r.length||e.length===0)return;const w=Array.from({length:e.length},(j,m)=>m);let h=this.weights.slice(),z=this.bias,D=this.misclassificationRate(e,r),c=0;for(let j=0;j<a&&c<s;j++){if(R)for(let m=w.length-1;m>0;m--){const _=Math.floor(Math.random()*(m+1)),y=w[m];w[m]=w[_],w[_]=y}for(let m=0;m<w.length&&c<s;m++){const _=w[m],y=e[_],G=this.mapLabel(r[_],"01"),b=this.predict(y),N=G-b;if(N!==0){for(let P=0;P<this.weights.length;P++)this.weights[P]+=this.lr*N*y[P];this.bias+=this.lr*N,c++;const t=this.misclassificationRate(e,r);t<D&&(D=t,h=this.weights.slice(),z=this.bias)}}}this.weights=h,this.bias=z}fitFast(e,r,i={}){const a=i.epochs??this.epochs,R=i.shuffle??!0,s=e?.length??0;if(!s||!Array.isArray(e)||!Array.isArray(r)||r.length!==s)return;const w=e[0].length,h=new Float32Array(s*w),z=new Int8Array(s);for(let y=0,G=0;y<s;y++){const b=e[y];for(let t=0;t<w;t++,G++)h[G]=b[t];const N=r[y]===1||r[y]==="1"||r[y]==="A"?1:0;z[y]=N}const D=new Int32Array(s);for(let y=0;y<s;y++)D[y]=y;const c=this.weights.slice();let j=this.bias;const m=this.lr,_=c.length;for(let y=0;y<a;y++){if(R)for(let b=s-1;b>0;b--){const N=Math.random()*(b+1)|0,t=D[b];D[b]=D[N],D[N]=t}let G=0;if(_===2&&w===2)for(let b=0;b<s;b++){const N=D[b],t=N*2,P=h[t],$=h[t+1],S=j+c[0]*P+c[1]*$>=0?1:0,d=z[N]-S;d&&(G++,c[0]+=m*d*P,c[1]+=m*d*$,j+=m*d)}else for(let b=0;b<s;b++){const N=D[b];let t=j,P=N*w;for(let S=0;S<w;S++)t+=c[S]*h[P+S];const $=t>=0?1:0,x=z[N]-$;if(x){G++,P=N*w;for(let S=0;S<w;S++)c[S]+=m*x*h[P+S];j+=m*x}}if(G===0)break}this.weights=c,this.bias=j}}class Ft{constructor(e=2,r=.05,i=1){if(e!==2)throw new Error("Only degree=2 polynomial is supported currently");this.degree=e,this.model=new _t(5,r,i)}transform(e){const[r,i]=e;return[r,i,r*r,i*i,r*i]}predict(e){const r=this.transform(e);return this.model.predict(r)}predictRaw(e){const r=this.transform(e);if(typeof this.model.predictRaw=="function")return this.model.predictRaw(r);let i=this.model.bias;for(let a=0;a<this.model.weights.length;a++)i+=this.model.weights[a]*r[a];return i}trainSample(e,r){const i=this.transform(e);return this.model.trainSample(i,r)}fit(e,r){const i=e.map(a=>this.transform(a));return this.model.fit(i,r)}reset(){this.model.weights=Array.from({length:this.model.weights.length},()=>Math.random()-.5),this.model.bias=Math.random()-.5}misclassificationRate(e,r){if(!Array.isArray(e)||!Array.isArray(r)||e.length!==r.length)return NaN;const i=e.map(a=>this.transform(a));return this.model.misclassificationRate(i,r)}hingeLoss(e,r){if(!Array.isArray(e)||!Array.isArray(r)||e.length!==r.length)return NaN;const i=e.map(a=>this.transform(a));return this.model.hingeLoss(i,r)}mseRaw(e,r){if(!Array.isArray(e)||!Array.isArray(r)||e.length!==r.length)return NaN;const i=e.map(a=>this.transform(a));return this.model.mseRaw(i,r)}fitHingeSGD(e,r,i={}){if(!Array.isArray(e)||!Array.isArray(r)||e.length!==r.length)return;const a=e.map(R=>this.transform(R));return this.model.fitHingeSGD(a,r,i)}}const It="_container_1mytx_1",Ct="_btn_1mytx_15",Bt="_btnRight_1mytx_28",zt="_btnLeft_1mytx_31",Ot="_equation_1mytx_34",ht={container:It,btn:Ct,btnRight:Bt,btnLeft:zt,equation:Ot};var Pt={};const Tt=({classifierType:q="linear",dataset:e,onDatasetChange:r,resetToken:i,speedScale:a=1})=>{const R=X.useRef(null),s=X.useRef(null),w=X.useRef(null),h=X.useRef(null),[z,D]=X.useState(!0),c=()=>{try{const _=globalThis.process;return!!(_&&_.env&&_.env.NODE_ENV!=="production")}catch{return!1}};X.useEffect(()=>{const _=t=>isFinite(t)?Math.abs(t)<1e-6?0:Number(t.toFixed(3)):"0",y=(t=[],P=0)=>{if(t.length<2)return"linear: no weights";const $=t[0],x=t[1];if(Math.abs(x)>1e-8){const S=-$/x,d=-P/x;return`y = ${_(S)} x ${d>=0?"+":"-"} ${_(Math.abs(d))}`}else if(Math.abs($)>1e-8)return`x = ${_(-P/$)}`;return"degenerate boundary"},G=(t=[],P=0)=>{const $=[],x=["x","y","x^2","y^2","xy"];for(let S=0;S<Math.min(t.length,5);S++)Math.abs(t[S])<1e-6||$.push(`${_(t[S])}·${x[S]}`);return`${$.join(" + ")||"0"} ${P>=0?"+":"-"} ${_(Math.abs(P))} = 0`},b=t=>{const P=t;let $=[],x=[],S=[],d=null,pt=6,lt=14,At=lt,Rt=18,ft=!1,g,I=!1,tt=e&&Array.isArray(e)&&e.length?1:.3,ut=0,J=0,et=0,dt=0,nt=0,Y=!1,it=0,K=null;const St=300,vt=150,st=()=>q==="poly"?new Ft(2,.05,1):new _t(2,.05,1),T=o=>{const n=o;return{raw:o,predict:u=>n?typeof n.predict=="function"?n.predict(u):n.raw&&typeof n.raw.predict=="function"?n.raw.predict(u):0:0,predictRaw:u=>n?typeof n.predictRaw=="function"?n.predictRaw(u):n.raw&&typeof n.raw.predictRaw=="function"?n.raw.predictRaw(u):0:0,trainSample:(u,p)=>{if(n){if(typeof n.trainSample=="function")return n.trainSample(u,p);if(typeof n.fit=="function")return n.fit([u],[p])}},get weights(){return n?.weights||n?.model?.weights||n?.raw?.weights||n?.raw?.model?.weights||[]},get bias(){const u=n?.bias??n?.model?.bias??n?.raw?.bias??n?.raw?.model?.bias;return typeof u=="number"?u:0},misclassificationRate:(u,p)=>{try{if(n&&typeof n.misclassificationRate=="function")return n.misclassificationRate(u,p);if(n&&n.raw&&typeof n.raw.misclassificationRate=="function")return n.raw.misclassificationRate(u,p)}catch(C){return c()&&console.debug("perceptron: misclassificationRate error",C),NaN}return NaN},hingeLoss:(u,p)=>{try{if(n&&typeof n.hingeLoss=="function")return n.hingeLoss(u,p);if(n&&n.raw&&typeof n.raw.hingeLoss=="function")return n.raw.hingeLoss(u,p)}catch(C){return c()&&console.debug("perceptron: hingeLoss error",C),NaN}return NaN},fitHingeSGD:(u,p,C)=>{if(n){if(typeof n.fitHingeSGD=="function")return n.fitHingeSGD(u,p,C);if(n.raw&&typeof n.raw.fitHingeSGD=="function")return n.raw.fitHingeSGD(u,p,C)}}}},ot=()=>{try{const o=g&&g.weights||[],n=g&&g.bias||0;return q==="linear"?o.length>=2?y(o,n):"linear: insufficient weights":G(o,n)}catch(o){return c()&&console.debug("perceptron: getCurrentEquation error",o),""}};let mt=null,at=null;const Nt=()=>{g=T(st()),$=[],x=[],S=[],J=et=0,nt=0,dt=0,Y=!1,mt=null,at=null,I=!1,ut=0,ft=!1;try{d&&d.clear()}catch{}try{yt()}catch{}for(let o=0;o<50;o++){const n=t.random(-1,1),u=t.random(-1,1),p=n*.5+.2>u?1:-1;$.push({x:n,y:u,labelSigned:p}),x.push([n,u]),S.push(p===1?1:0)}try{if(q==="linear"&&x.length>vt&&g&&g.raw&&typeof g.raw.fitFast=="function"){const o=Math.max(20,Math.round(60/Math.max(.1,tt)));g.raw.fitFast(x,S,{epochs:o,shuffle:!0}),I=!0,Y=!0;try{const n=ot();window.mlvStatus={classifier:q,equation:n,weights:g.weights,bias:g.bias,updatedAt:Date.now()},window.dispatchEvent(new CustomEvent("mlv:demo-finished",{detail:{classifier:q,reason:"fast-trained",elapsedSec:0}}))}catch(n){c()&&console.debug("perceptron: fast-train publish error",n)}}}catch(o){c()&&console.debug("perceptron: fast-train error",o)}try{K=performance&&performance.now?performance.now():Date.now()}catch{K=Date.now()}try{h.current&&(h.current.style.display="none")}catch{}try{if(q==="linear"&&x.length>vt&&g&&g.raw&&typeof g.raw.fitFast=="function"){const o=Math.max(20,Math.round(60/Math.max(.1,tt)));g.raw.fitFast(x,S,{epochs:o,shuffle:!0}),I=!0,Y=!0;try{const n=ot();window.mlvStatus={classifier:q,equation:n,weights:g.weights,bias:g.bias,updatedAt:Date.now()},window.dispatchEvent(new CustomEvent("mlv:demo-finished",{detail:{classifier:q,reason:"fast-trained",elapsedSec:0}}))}catch(n){c()&&console.debug("perceptron: fast-train publish error",n)}}}catch(o){c()&&console.debug("perceptron: fast-train error",o)}};t.updateDataset=o=>{if($=[],x=[],S=[],o&&Array.isArray(o)&&o.length)for(const n of o){const u=n.x,p=n.y,C=n.label==="A"?1:-1;$.push({x:u,y:p,labelSigned:C}),x.push([u,p]),S.push(C===1?1:0)}g=T(st()),J=et=0,nt=0,dt=0,Y=!1,mt=null,at=null,I=!1,ut=0,ft=!1;try{d&&d.clear()}catch{}try{yt()}catch{}try{K=performance&&performance.now?performance.now():Date.now()}catch{K=Date.now()}try{h.current&&(h.current.style.display="none")}catch{}};const wt=(o,n)=>{try{g.trainSample(o,n)}catch{g=T(st())}},Q=o=>{try{return g.predict(o)}catch{return g=T(st()),0}},Et=o=>{try{return g.predictRaw(o)}catch{return g=T(st()),0}},yt=()=>{const o=Math.max(1,Math.min(t.width||600,t.height||600)),n=Math.max(4,Math.floor(o/90));pt=n,lt=Math.max(8,n*2),e&&Array.isArray(e)&&e.length>150&&(pt=Math.max(pt,8),lt=Math.max(lt,16))};t.setup=()=>{R.current&&R.current.querySelectorAll("canvas").forEach(p=>p.remove());const o=R.current?.getBoundingClientRect(),n=Math.max(300,o?.width||600),u=Math.max(300,o?.height||600);t.createCanvas(n,u);try{t.frameRate?.(45)}catch{}try{t.pixelDensity?.(1)}catch{}d=t.createGraphics?t.createGraphics(t.width,t.height):null,yt(),R.current&&R.current.querySelectorAll(".pd-fallback, .pd-status").forEach(p=>p.remove()),w.current&&(w.current.textContent=""),Nt(),e&&Array.isArray(e)&&e.length&&t.updateDataset(e),t.maximizeMargin=(p={})=>{try{const C=performance&&performance.now?performance.now():Date.now();if(!Array.isArray(x)||x.length===0)return;const bt={epochs:120,lr:.01,lambda:.001,shuffle:!0,...p},xt=p.lr?[p.lr]:[.005,.01,.02,.04],M=p.lambda?[p.lambda]:[5e-4,.001,.003],L=Math.max(80,bt.epochs),O=3;let v=null;const B=(()=>{try{const l=x.length,f=(S||[]).map(A=>A===1?"1":"0").join(""),k=x.slice(0,120).map(A=>`${Number(A[0]).toFixed(3)},${Number(A[1]).toFixed(3)}`).join("|");return`${l}|${f}|${k}`}catch(l){return c()&&console.debug("perceptron: sig build error",l),`n${x&&x.length}`}})();if(mt&&B===mt&&at){g=T(at),I=!0,Y=!0;try{d&&d.clear()}catch(f){c()&&console.debug("perceptron: grid clear error",f)}let l=1;try{const f=T(at);typeof f.misclassificationRate=="function"&&(l=1-f.misclassificationRate(x,S))}catch{typeof globalThis.process<"u"}try{const k=((performance&&performance.now?performance.now():Date.now())-C)/1e3;window.dispatchEvent(new CustomEvent("mlv:demo-finished",{detail:{classifier:q==="poly"?"Polynomial Perceptron":"Linear Perceptron",reason:"max-margin",accuracy:l,elapsedSec:k}})),h.current&&(h.current.innerText=`Max margin finished — Time: ${k.toFixed(2)}s`,h.current.style.display="block")}catch(f){c()&&console.debug("perceptron: event/DOM error",f)}return}const E=l=>{let f=Number.POSITIVE_INFINITY,k=Number.POSITIVE_INFINITY;try{const A=T(l);f=typeof A.misclassificationRate=="function"?A.misclassificationRate(x,S):f}catch(A){c()&&console.debug("perceptron: misclassificationRate error",A)}try{const A=T(l);k=typeof A.hingeLoss=="function"?A.hingeLoss(x,S):k}catch(A){c()&&console.debug("perceptron: hingeLoss error",A)}return{err:isFinite(f)?f:1e9,hinge:isFinite(k)?k:1e9,model:l}};for(const l of xt)for(const f of M)for(let k=0;k<O;k++){const A=st();try{const W=T(A);typeof W.fitHingeSGD=="function"&&W.fitHingeSGD(x,S,{epochs:L,lr:l,lambda:f,shuffle:!0})}catch(W){c()&&console.debug("perceptron: fitHingeSGD error",W)}const F=E(A);(!v||F.err<v.err-1e-9||Math.abs(F.err-v.err)<1e-9&&F.hinge<v.hinge)&&(v=F)}if(v&&v.model){g=T(v.model),mt=B,at=v.model,I=!0,Y=!0;try{d&&d.clear()}catch(f){c()&&console.debug("perceptron: grid clear error",f)}let l=1;try{const f=T(v.model);typeof f.misclassificationRate=="function"&&(l=1-f.misclassificationRate(x,S))}catch{typeof globalThis.process<"u"}try{const k=((performance&&performance.now?performance.now():Date.now())-C)/1e3;window.dispatchEvent(new CustomEvent("mlv:demo-finished",{detail:{classifier:q==="poly"?"Polynomial Perceptron":"Linear Perceptron",reason:"max-margin",accuracy:l,elapsedSec:k}})),h.current&&(h.current.innerText=`Max margin finished — Time: ${k.toFixed(2)}s`,h.current.style.display="block")}catch(f){c()&&console.debug("perceptron: event/DOM error",f)}}}catch(C){console.error("maximizeMargin error",C)}}},t.windowResized=()=>{const o=R.current?.getBoundingClientRect();t.resizeCanvas(Math.max(300,o?.width||600),Math.max(300,o?.height||600)),d=t.createGraphics?t.createGraphics(t.width,t.height):null,yt()},t.draw=()=>{try{if(typeof document<"u"&&document.hidden)return}catch(M){c()&&console.debug("perceptron: visibility probe error",M)}if(!I&&x.length&&J<St){const M=tt*(t.speedScale||1);ut+=M;let L=Math.floor(ut);if(L>0){ut-=L,L=Math.min(L,5);for(let O=0;O<L;O++){const v=x[et],B=S[et],E=Et(v);(E>=0?1:0)!==B&&dt++;try{const f=g.raw||g;f&&typeof f.trainSampleScore01=="function"?f.trainSampleScore01(v,B,E):f&&typeof f.trainSampleRaw01=="function"?f.trainSampleRaw01(v,B):wt(v,B)}catch{wt(v,B)}if(et++,et>=x.length){if(J++,et=0,dt===0){if(nt++,(nt>=2&&J>=2||nt>=1&&J>=5)&&!I&&!Y){I=!0,Y=!0,it=performance&&performance.now?performance.now():Date.now();try{try{const F=ot();window.mlvStatus={classifier:q,equation:F,weights:g.weights,bias:g.bias,updatedAt:Date.now()}}catch(F){c()&&console.debug("perceptron: candidate eval error",F)}let k=1;try{typeof g.misclassificationRate=="function"&&(k=1-g.misclassificationRate(x,S))}catch(F){c()&&console.debug("perceptron: candidate eval error",F)}const A=K!=null?(it-K)/1e3:void 0;window.dispatchEvent(new CustomEvent("mlv:demo-finished",{detail:{classifier:q==="poly"?"Polynomial Perceptron":"Linear Perceptron",reason:"converged",epoch:J,equation:ot(),accuracy:k,elapsedSec:A}}));try{if(h.current){const F=`Training finished — Time: ${(A??0).toFixed(2)}s`;h.current.innerText=F,h.current.style.display="block"}}catch(F){c()&&console.debug("perceptron: candidate eval error",F)}}catch{}}}else nt=0;if(dt=0,J>=St&&!Y){I=!0,Y=!0,it=performance&&performance.now?performance.now():Date.now();try{try{const A=ot();window.mlvStatus={classifier:q,equation:A,weights:g.weights,bias:g.bias,updatedAt:Date.now()}}catch(A){c()&&console.debug("perceptron: event/DOM error",A)}let f=1;try{typeof g.misclassificationRate=="function"&&(f=1-g.misclassificationRate(x,S))}catch(A){c()&&console.debug("perceptron: event/DOM error",A)}const k=K!=null?(it-K)/1e3:void 0;window.dispatchEvent(new CustomEvent("mlv:demo-finished",{detail:{classifier:q==="poly"?"Polynomial Perceptron":"Linear Perceptron",reason:"max-epochs",epoch:J,equation:ot(),accuracy:f,elapsedSec:k}}));try{if(h.current){const A=`Training finished — Time: ${(k??0).toFixed(2)}s`;h.current.innerText=A,h.current.style.display="block"}}catch(A){c()&&console.debug("perceptron: DOM update error",A)}}catch{}}}}}}const o=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,n=()=>{const M=performance&&performance.now?performance.now():Date.now();return Y&&it&&M-it<500};if(t.background(o?38:232),q==="poly"){const M=n();if(At=I&&!M?pt:lt,Rt=I&&!M?40:18,d||(d=t.createGraphics?t.createGraphics(t.width,t.height):null),ft!==I&&(ft=I,!M))try{d.clear()}catch(L){c()&&console.debug("perceptron: grid clear race",L)}if(!M&&(t.frameCount%Rt===0||ft!==I)){d.clear(),d.noStroke();const L=Math.max(3,At),O=Math.max(2,Math.floor(L*.9));for(let v=0;v<t.height;v+=L){const E=Math.floor(v/L)%2===1?L/2:0;for(let l=-E;l<t.width;l+=L){const f=l+E+L/2,k=v+L/2;if(f<0||f>t.width||k<0||k>t.height)continue;const A=t.map(f,0,t.width,-1,1),F=t.map(k,t.height,0,-1,1);let W=0;try{W=Et([A,F])}catch{W=0}if(W===0)try{const H=g&&g.weights||[],ct=g&&g.bias||0;H.length>=5&&(W=ct+H[0]*A+H[1]*F+H[2]*A*A+H[3]*F*F+H[4]*A*F)}catch(H){c()&&console.debug("perceptron: raw fallback error",H)}const kt=Q([A,F])===1?1:-1,V=Math.min(1,Math.abs(W)),U=Math.tanh(V*.8),Z=(o?.3:.34)+U*(o?.15:.18);d.fill(kt===1?o?`rgba(235,70,70,${Z.toFixed(3)})`:`rgba(230,120,120,${Z.toFixed(3)})`:o?`rgba(50,110,210,${Z.toFixed(3)})`:`rgba(110,170,230,${Z.toFixed(3)})`),d.ellipse(f,k,O,O)}}}t.image(d,0,0)}else if(q==="linear"){d||(d=t.createGraphics?t.createGraphics(t.width,t.height):null);const M=o?"rgba(235,70,70,0.35)":"rgba(230,120,120,0.40)",L=o?"rgba(50,110,210,0.35)":"rgba(110,170,230,0.40)",O=n(),v=I&&!O?1:2,B=g.weights||[],E=g.bias||0;P._linLast=P._linLast||{w0:NaN,w1:NaN,b:NaN,colStep:NaN,w:0,h:0};const l=P._linLast,f=B[0]??NaN,k=B[1]??NaN,A=l.w!==t.width||l.h!==t.height,F=l.colStep!==v,W=!(Math.abs(l.w0-f)<1e-6&&Math.abs(l.w1-k)<1e-6&&Math.abs(l.b-E)<1e-6);if((A||F||W)&&!O&&((I?1:0)||t.frameCount%6===0)){if(d.clear(),d.noStroke(),B.length>=2)if(Math.abs(k)>1e-8)for(let V=0;V<t.width;V+=v){const U=t.map(V+v/2,0,t.width,-1,1),Z=-(f*U+E)/k,H=t.map(Z,-1,1,t.height,0),ct=t.map(Math.max(0,H-1),t.height,0,-1,1),gt=t.map(Math.min(t.height,H+1),t.height,0,-1,1),qt=Q([U,ct])===1,Dt=Q([U,gt])===1,Lt=Math.max(0,Math.min(t.height,H)),Mt=Math.max(0,Math.min(t.height,H));Lt>0&&(d.fill(qt?M:L),d.rect(V,0,v,Lt)),Mt<t.height&&(d.fill(Dt?M:L),d.rect(V,Mt,v,t.height-Mt))}else if(Math.abs(f)>1e-8){const V=-E/f,U=t.map(V,-1,1,0,t.width),Z=Q([t.map(Math.max(0,U-1),0,t.width,-1,1),0])===1,H=Q([t.map(Math.min(t.width,U+1),0,t.width,-1,1),0])===1,ct=Math.max(0,Math.min(t.width,U)),gt=Math.max(0,Math.min(t.width,U));ct>0&&(d.fill(Z?M:L),d.rect(0,0,ct,t.height)),gt<t.width&&(d.fill(H?M:L),d.rect(gt,0,t.width-gt,t.height))}else{const V=Q([0,0])===1;d.fill(V?M:L),d.rect(0,0,t.width,t.height)}l.w0=f,l.w1=k,l.b=E,l.colStep=v,l.w=t.width,l.h=t.height}t.image(d,0,0)}const u=g.weights||[],p=g.bias||0;try{if(q==="linear"){const M=u.length>=2?y(u,p):"linear: insufficient weights";window.mlvStatus={classifier:"linear",equation:M,weights:u,bias:p,updatedAt:Date.now()}}else if(q==="poly"){const M=G(u,p);window.mlvStatus={classifier:"poly",equation:M,weights:u,bias:p,updatedAt:Date.now()}}}catch{}if(q==="linear"&&Y&&u.length>=2){o?t.stroke(255,255,255,220):t.stroke(0,0,0,220);const M=u[0],L=u[1];if(Math.abs(L)>1e-6){const O=[],v=(E,l)=>{E>=-1.00000001&&E<=1.00000001&&l>=-1.00000001&&l<=1.00000001&&O.push({x:Math.max(-1,Math.min(1,E)),y:Math.max(-1,Math.min(1,l))})};try{const l=-(M*-1+p)/L;v(-1,l)}catch(E){c()&&console.debug("perceptron: intersection compute error",E)}try{const l=-(M*1+p)/L;v(1,l)}catch(E){c()&&console.debug("perceptron: intersection compute error",E)}if(Math.abs(M)>1e-12){try{const l=-(L*-1+p)/M;v(l,-1)}catch(E){c()&&console.debug("perceptron: intersection compute error",E)}try{const l=-(L*1+p)/M;v(l,1)}catch(E){c()&&console.debug("perceptron: intersection compute error",E)}}const B=[];for(const E of O)B.some(l=>Math.hypot(l.x-E.x,l.y-E.y)<1e-6)||B.push(E);if(B.length>=2){const[E,l]=[B[0],B[1]];t.line(t.map(E.x,-1,1,0,t.width),t.map(E.y,-1,1,t.height,0),t.map(l.x,-1,1,0,t.width),t.map(l.y,-1,1,t.height,0))}else{const f=-(M*-1+p)/L,k=-(M*1+p)/L;t.line(t.map(-1,-1,1,0,t.width),t.map(f,-1,1,t.height,0),t.map(1,-1,1,0,t.width),t.map(k,-1,1,t.height,0))}}else if(Math.abs(M)>1e-6){const O=-p/M,v=t.map(O,-1,1,0,t.width);t.line(v,0,v,t.height)}}for(let M of $){const L=t.map(M.x,-1,1,0,t.width),O=t.map(M.y,-1,1,t.height,0),v=Q([M.x,M.y])===1?1:-1;t.fill(M.labelSigned===1?"#e53e3e":"#4299e1"),t.stroke(0),t.circle(L,O,8),v!==M.labelSigned&&(t.noFill(),t.stroke(0),t.circle(L,O,12))}let C=!1;const bt=t.map(t.mouseX,0,t.width,-1,1),xt=t.map(t.mouseY,t.height,0,-1,1);if(q==="linear"&&Y&&u.length>=2&&Math.abs(u[1])>1e-6){const M=-(u[0]*bt+p)/u[1];Math.abs(M-xt)<.05&&(C=!0)}else q==="poly"&&Y&&Math.abs(Q([bt,xt])-.5)<.1&&(C=!0);w.current&&(w.current.style.opacity=C?"1":"0",C&&(w.current.textContent=q==="linear"?y(u,p):G(u,p)))},t.keyPressed=()=>{const o=t.map(t.mouseX,0,t.width,-1,1),n=t.map(t.mouseY,t.height,0,-1,1);if(t.key===" "){I=!I;return}t.key==="b"&&($.push({x:o,y:n,labelSigned:1}),x.push([o,n]),S.push(1),wt([o,n],1),r&&r(u=>[...u,{x:o,y:n,label:"A"}])),t.key==="r"&&($.push({x:o,y:n,labelSigned:-1}),x.push([o,n]),S.push(0),wt([o,n],0),r&&r(u=>[...u,{x:o,y:n,label:"B"}])),(t.key==="+"||t.key==="=")&&(tt=Math.min(20,tt+1)),(t.key==="-"||t.key==="_")&&(tt=Math.max(0,tt-1))},t.resetDemo=()=>{try{r&&r([])}catch{}Nt();try{window.dispatchEvent(new CustomEvent("mlv:demo-reset",{detail:{classifier:q}}))}catch{}try{h.current&&(h.current.style.display="none")}catch{}}};let N=!0;return D(!0),(async()=>{try{const t=await Gt();if(!N)return;const P=t&&t.default||t;s.current&&(s.current.remove(),s.current=null),R.current&&(s.current=new P(b,R.current)),D(!1)}catch(t){c()&&console.debug("perceptron: dynamic import p5 failed",t),D(!1)}})(),()=>{N=!1,s.current&&(s.current.remove(),s.current=null)}},[q,e,r]),X.useEffect(()=>{s.current&&typeof s.current.updateDataset=="function"&&s.current.updateDataset(e||[])},[i,e]),X.useEffect(()=>{s.current&&(s.current.speedScale=a||1)},[a]);const j=jt.useCallback(()=>{try{r&&r([])}catch{}s.current&&(typeof s.current.resetDemo=="function"?s.current.resetDemo():typeof s.current.updateDataset=="function"&&s.current.updateDataset([]))},[r]),m=jt.useCallback(()=>{s.current&&typeof s.current.maximizeMargin=="function"&&s.current.maximizeMargin()},[]);return rt.jsxs("div",{ref:R,className:ht.container,children:[z&&rt.jsx("div",{style:{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(255,255,255,0.6)",zIndex:2e3},children:rt.jsx("div",{style:{padding:10,borderRadius:6,background:"rgba(0,0,0,0.6)",color:"#fff",fontWeight:600,fontSize:12},children:"Loading demo…"})}),rt.jsx("button",{type:"button",id:"perceptron-reset",onClick:j,className:`${ht.btn} ${ht.btnLeft}`,children:"Reset"}),rt.jsx("button",{type:"button",id:"perceptron-maximize",onClick:m,className:`${ht.btn} ${ht.btnRight}`,children:"Maximize margin"}),rt.jsx("div",{ref:w,className:ht.equation}),rt.jsx("div",{ref:h,style:{position:"absolute",top:8,left:"50%",transform:"translateX(-50%)",background:"rgba(0,0,0,0.6)",color:"#fff",padding:"6px 10px",borderRadius:6,fontSize:11,letterSpacing:.2,display:"none",zIndex:1500,boxShadow:"0 3px 10px rgba(0,0,0,0.25)"},children:"Training finished"})]})};export{Tt as default};
